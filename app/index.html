<html>
  <head>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
    <style>
      body { font-family: 'Roboto Slab', serif; background-color: black; color: #35DE08; }
      a { color: #35DE08; }
      #listBox, #musicBox, #playlist { display: inline-block; border: 1px solid #35DE08; padding: 10px; }
      .title { font-size: 30px; font-weight: bold; padding: 15px 0; }
      .item { cusour: pointer; }
      .item:hover { background-color: blue; color: white; }
      .listened { text-decoration: line-through; color: grey; }
      .nowPlaying { color: blue; }
      .button { display: inline; color: white; padding: 5px; margin-right: 10px; border: 2px solid #35DE08; }
      .button:hover { background-color: blue; color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script>
      function listenSong(name) {
        return function () {
        var request = new XMLHttpRequest();
        request.open("get", "/listen_song/" + name, true);
        request.setRequestHeader('Accept', 'application/json, text/javascript');
        request.onreadystatechange = function () {
          if (request.readyState != 4 || request.status != 200) return;
          var response = JSON.parse(request.response);
          var playListBox = document.getElementById('playlist');
          playListBox.innerHTML = '';
          _.each(response.reservedSongs, (song, idx) => {
            var item = document.createElement('div');
            item.innerHTML = `${idx + 1}. ${song}`;

            if (idx < response.nowPlayingIndex) item.setAttribute('class', 'listened');
            if (idx == response.nowPlayingIndex) item.setAttribute('class', 'nowPlaying');
            playListBox.appendChild(item);
          })
          alert('added');
        }
        request.send();
        }
      }

      function controllPlayer(command) {
        console.log('clicked');
        var request = new XMLHttpRequest();
        request.open("get", "/controll/" + (command || 'q'), true);
        request.onreadystatechange = function () {
          if (request.readyState != 4 || request.status != 200) return;
          getPlayList();
        }
        request.send();
      }

      function getSongs() {
        var request = new XMLHttpRequest();
        request.open("get", "/get_list", true);
        request.onreadystatechange = function () {
        if (request.readyState != 4 || request.status != 200) return;
          var songs = JSON.parse(request.response);
          console.log(songs);
          var listBox = document.getElementById("listBox");
          var musicBox = document.getElementById("musicBox");

          for(var i = 0; i < songs.length; i++) {
            console.log(songs[i])
            var item = document.createElement('div');
            var aTag = document.createElement('a');

            var itemForListen = document.createElement('div');

            item.setAttribute('class', 'item');
            itemForListen.setAttribute('class', 'item');
            itemForListen.innerHTML = songs[i];
            itemForListen.onclick = listenSong(songs[i]);
            aTag.innerHTML = songs[i];
            aTag.href = '/download/' + songs[i];
            item.appendChild(aTag);
            listBox.appendChild(item);
            musicBox.appendChild(itemForListen);
          };

        };
        request.send();
      }

      function getPlayList() {
        var request = new XMLHttpRequest();
        request.open("get", "/get_play_list", true);
        request.onreadystatechange = function () {
          if (request.readyState != 4 || request.status != 200) return;
          var response = JSON.parse(request.response);
          var playListBox = document.getElementById('playlist');
          var volumeStatus = document.querySelector('.volume');
          volumeStatus.innerText = 'vol: ' +response.volume + 'dB';
          playListBox.innerHTML = '';
          _.each(response.reservedSongs, (song, idx) => {
            var item = document.createElement('div');
            item.innerHTML = `${idx + 1}. ${song}`;
            if (idx < response.nowPlayingIndex) item.setAttribute('class', 'listened')
            if (idx == response.nowPlayingIndex) item.setAttribute('class', 'nowPlaying');
            playListBox.appendChild(item);
          })
        };
        request.send();
      }

      getSongs();
      getPlayList();

      setInterval(function() { getPlayList(); }, 3000);
    </script>
  </head>
  <body>
    <div class="title">song list(for download)</div>
    <div id="listBox"></div>
    <div class="title">click song you wanna listen</div>
    <div id="musicBox"></div>
    <div class="title">play list</div>
    <div id="playlist"></div>
    <br /><br />
    <div class="button" onclick="controllPlayer()">NEXT</div>
    <div class="button" onclick="controllPlayer('+')">UP</div>
    <div class="button" onclick="controllPlayer('-')">DOWN</div>
    <div class="button volume">vol</div>
  </body>
</html>
